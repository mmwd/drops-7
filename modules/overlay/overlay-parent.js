(function(a){Drupal.behaviors.overlayParent={attach:function(b,c){if(Drupal.overlay.isOpen){Drupal.overlay.makeDocumentUntabbable(b)}if(this.processed){return}this.processed=true;a(window).bind("hashchange.drupal-overlay",a.proxy(Drupal.overlay,"eventhandlerOperateByURLFragment")).triggerHandler("hashchange.drupal-overlay");a(document).bind("click.drupal-overlay mouseup.drupal-overlay",a.proxy(Drupal.overlay,"eventhandlerOverrideLink"))}};Drupal.overlay=Drupal.overlay||{isOpen:false,isOpening:false,isClosing:false,isLoading:false};Drupal.overlay.prototype={};Drupal.overlay.open=function(b){if(this.isOpen||this.isOpening){return this.load(b)}this.isOpening=true;this.originalTitle=document.title;this.create();this.isOpening=false;this.isOpen=true;a(document.documentElement).addClass("overlay-open");this.makeDocumentUntabbable();a(document).trigger("drupalOverlayOpen");return this.load(b)};Drupal.overlay.create=function(){this.$container=a(Drupal.theme("overlayContainer")).appendTo(document.body);this.activeFrame=this.$iframeA=a(Drupal.theme("overlayElement")).appendTo(this.$container);this.inactiveFrame=this.$iframeB=a(Drupal.theme("overlayElement")).appendTo(this.$container);this.$iframeA.bind("load.drupal-overlay",{self:this.$iframeA[0],sibling:this.$iframeB},a.proxy(this,"loadChild"));this.$iframeB.bind("load.drupal-overlay",{self:this.$iframeB[0],sibling:this.$iframeA},a.proxy(this,"loadChild"));var b=".drupal-overlay.drupal-overlay-open";a(window).bind("resize"+b,a.proxy(this,"eventhandlerOuterResize"));a(document).bind("drupalOverlayLoad"+b,a.proxy(this,"eventhandlerOuterResize")).bind("drupalOverlayReady"+b+" drupalOverlayClose"+b,a.proxy(this,"eventhandlerSyncURLFragment")).bind("drupalOverlayClose"+b,a.proxy(this,"eventhandlerRefreshPage")).bind("drupalOverlayBeforeClose"+b+" drupalOverlayBeforeLoad"+b+" drupalOverlayResize"+b,a.proxy(this,"eventhandlerDispatchEvent"));if(a(".overlay-displace-top, .overlay-displace-bottom").length){a(document).bind("drupalOverlayResize"+b,a.proxy(this,"eventhandlerAlterDisplacedElements")).bind("drupalOverlayClose"+b,a.proxy(this,"eventhandlerRestoreDisplacedElements"))}};Drupal.overlay.load=function(b){if(!this.isOpen){return false}a(document).trigger("drupalOverlayBeforeLoad");a(document.documentElement).addClass("overlay-loading");var c=this.inactiveFrame[0].contentDocument||this.inactiveFrame[0].contentWindow.document;c.location.replace(b);return true};Drupal.overlay.close=function(){if(!this.isOpen||this.isClosing){return false}var b=a.Event("drupalOverlayBeforeClose");a(document).trigger(b);if(b.isDefaultPrevented()){return false}this.isClosing=true;this.isOpen=false;a(document.documentElement).removeClass("overlay-open");document.title=this.originalTitle;this.makeDocumentTabbable();a(document).trigger("drupalOverlayClose");if(!this.isLoading){this.destroy();this.isClosing=false}return true};Drupal.overlay.destroy=function(){a([document,window]).unbind(".drupal-overlay-open");this.$container.remove();this.$container=null;this.$iframeA=null;this.$iframeB=null;this.iframeWindow=null};Drupal.overlay.redirect=function(b){var c=a(b.link(b)).get(0);if(window.location.href==c.href){a(window).triggerHandler("hashchange.drupal-overlay")}window.location.href=c.href;return true};Drupal.overlay.bindChild=function(b,c){this.iframeWindow=b;if(c||this.isClosing||!this.isOpen){return}a(document).trigger("drupalOverlayReady")};Drupal.overlay.loadChild=function(e){var d=e.data.self;var f=d.contentDocument||d.contentWindow.document;var b=f.defaultView||f.parentWindow;if(b.location=="about:blank"){return}this.isLoading=false;a(document.documentElement).removeClass("overlay-loading");e.data.sibling.removeClass("overlay-active").attr({tabindex:-1});if(this.isOpen&&!this.isClosing){if(b.Drupal&&b.Drupal.overlayChild){document.title=b.document.title;this.activeFrame=a(d).addClass("overlay-active").attr("title",Drupal.t("@title dialog",{"@title":b.jQuery("#overlay-title").text()})).removeAttr("tabindex");this.inactiveFrame=e.data.sibling;(this.inactiveFrame[0].contentDocument||this.inactiveFrame[0].contentWindow.document).location.replace("about:blank");this.activeFrame.focus();var c=b.jQuery("a:first");Drupal.overlay.setFocusBefore(c,b.document);a(document).trigger("drupalOverlayLoad")}else{window.location=b.location.href.replace(/([?&]?)render=overlay&?/g,"$1").replace(/\?$/,"")}}else{this.destroy()}};Drupal.overlay.setFocusBefore=function(c,b){var e=b.createElement("a");var d=a(e).addClass("element-invisible").attr("href","#");d.insertBefore(c);d.focus();d.one("blur",function(){a(this).remove()})};Drupal.overlay.isAdminLink=function(b){if(Drupal.overlay.isExternalLink(b)){return false}var e=this.getPath(b);if(!this.adminPathRegExp){var d="";if(Drupal.settings.overlay.pathPrefixes.length){d="("+Drupal.settings.overlay.pathPrefixes.join("/|")+"/|)"}var f="^"+d+"("+Drupal.settings.overlay.paths.admin.replace(/\s+/g,"|")+")$";var c="^"+d+"("+Drupal.settings.overlay.paths.non_admin.replace(/\s+/g,"|")+")$";f=f.replace(/\*/g,".*");c=c.replace(/\*/g,".*");this.adminPathRegExp=new RegExp(f);this.nonAdminPathRegExp=new RegExp(c)}return this.adminPathRegExp.exec(e)&&!this.nonAdminPathRegExp.exec(e)};Drupal.overlay.isExternalLink=function(b){var c=RegExp("^((f|ht)tps?:)?//(?!"+window.location.host+")");return c.test(b)};Drupal.overlay.eventhandlerOuterResize=function(b){if(!(this.isOpen||this.isOpening)||this.isClosing||!this.iframeWindow){return}if(typeof document.body.style.maxHeight!="string"){this.activeFrame.height(a(window).height())}a(document).trigger("drupalOverlayResize")};Drupal.overlay.eventhandlerAlterDisplacedElements=function(f){if(!(this.isOpen||this.isOpening)||this.isClosing||!this.iframeWindow){return}a(this.iframeWindow.document.body).css({marginTop:Drupal.overlay.getDisplacement("top"),marginBottom:Drupal.overlay.getDisplacement("bottom")}).addClass("overlay-trigger-reflow").removeClass("overlay-trigger-reflow");var g=this.iframeWindow.document.body.clientHeight;var b=this.iframeWindow.document.body.clientWidth;var c=(typeof document.body.style.maxWidth=="string")?"maxWidth":"width";if(Drupal.overlay.leftSidedScrollbarOffset===undefined&&a(document.documentElement).attr("dir")==="rtl"){if(a.browser.opera){Drupal.overlay.leftSidedScrollbarOffset=document.documentElement.clientWidth-this.iframeWindow.document.documentElement.clientWidth+this.iframeWindow.document.documentElement.clientLeft}else{if(this.iframeWindow.document.documentElement.clientLeft){Drupal.overlay.leftSidedScrollbarOffset=this.iframeWindow.document.documentElement.clientLeft}else{var e=a('<div style="direction: rtl; overflow: scroll;"></div>').appendTo(document.body);var d=a("<div></div>").appendTo(e);Drupal.overlay.leftSidedScrollbarOffset=parseInt(d[0].offsetLeft-e[0].offsetLeft);e.remove()}}}a(".overlay-displace-top, .overlay-displace-bottom").each(function(){var k=a(this).data();var j=b;if(this.filters&&this.filters.length&&this.filters.item("DXImageTransform.Microsoft.Shadow")){j-=1}if(Drupal.overlay.leftSidedScrollbarOffset){a(this).css("left",Drupal.overlay.leftSidedScrollbarOffset)}var h=parseInt(a(this).css(c));if((k.drupalOverlay&&k.drupalOverlay.maxWidth)||isNaN(h)||h>j||h<=0){a(this).css(c,j);(k.drupalOverlay=k.drupalOverlay||{}).maxWidth=true}var l=a(this).offset();var i=l.left+a(this).outerWidth();if((k.drupalOverlay&&k.drupalOverlay.clip)||i>j){if(Drupal.overlay.leftSidedScrollbarOffset){a(this).css("clip","rect(auto, auto, "+(g-l.top)+"px, "+(Drupal.overlay.leftSidedScrollbarOffset+2)+"px)")}else{a(this).css("clip","rect(auto, "+(j-l.left)+"px, "+(g-l.top)+"px, auto)")}(k.drupalOverlay=k.drupalOverlay||{}).clip=true}})};Drupal.overlay.eventhandlerRestoreDisplacedElements=function(c){var d=a(".overlay-displace-top, .overlay-displace-bottom");try{d.css({maxWidth:"",clip:""})}catch(b){d.attr("style",function(f,e){return e.replace(/clip\s*:\s*rect\([^)]+\);?/i,"")})}};Drupal.overlay.eventhandlerOverrideLink=function(f){if((f.type=="click"&&f.button==2)||(f.type=="mouseup"&&f.button!=2)){return}var b=a(f.target);if(!b.is("a")){b=b.closest("a");if(!b.length){return}}if(b.hasClass("overlay-exclude")){return}if(b.hasClass("overlay-close")){a.bbq.removeState("overlay");return}var g=b[0];var c=g.href;if(c!=undefined&&c!=""&&g.protocol.match(/^https?\:/)){var e=c.replace(g.ownerDocument.location.href,"");if(e.length==0||e.charAt(0)=="#"){return}else{if(this.isAdminLink(c)){var i=(b.hasClass("overlay-restore")&&typeof a.bbq.getState("overlay-context")=="string")?Drupal.settings.basePath+a.bbq.getState("overlay-context"):null;c=this.fragmentizeLink(b.get(0),i);if(f.button==0&&!f.altKey&&!f.ctrlKey&&!f.metaKey&&!f.shiftKey){this.redirect(c);return false}else{b.one("blur mousedown",{target:g,href:g.href},function(j){a(j.data.target).attr("href",j.data.href)}).attr("href",c)}}else{if(this.isOpen&&g.ownerDocument===this.iframeWindow.document){if(g.hostname!=window.location.hostname){if(!b.attr("target")){b.attr("target","_parent")}}else{if(b[0].hash){}else{b.attr("href",a.param.fragment(c,{"overlay-context":this.getPath(window.location)+window.location.search}))}var h=a.deparam.querystring(c);if(h.destination&&this.isAdminLink(h.destination)){var d=a.param.fragment(this.getPath(window.location),{overlay:h.destination});b.attr("href",a.param.querystring(c,{destination:d}))}b.attr("target","_parent")}}}}}};Drupal.overlay.eventhandlerOperateByURLFragment=function(c){if(a.data(window.location,window.location.href)==="redirect"){a.data(window.location,window.location.href,null);return}var d=a.bbq.getState("overlay");if(d){var b=a.param.querystring(Drupal.settings.basePath+d,{render:"overlay"});this.open(b);this.resetActiveClass(this.getPath(Drupal.settings.basePath+d))}else{if(this.isOpen&&!this.isClosing){this.close();this.resetActiveClass(this.getPath(window.location))}}};Drupal.overlay.eventhandlerSyncURLFragment=function(c){if(this.isOpen){var b=a.bbq.getState("overlay");if(this.getPath(Drupal.settings.basePath+b)!=this.getPath(this.iframeWindow.document.location)){var d=Drupal.overlay.fragmentizeLink(this.iframeWindow.document.location);a.data(window.location,d,"redirect");window.location.replace(d)}}else{a.bbq.removeState("overlay")}};Drupal.overlay.eventhandlerRefreshPage=function(b){if(Drupal.overlay.refreshPage){window.location.reload(true)}};Drupal.overlay.eventhandlerDispatchEvent=function(b){if(this.iframeWindow&&this.iframeWindow.document){this.iframeWindow.jQuery(this.iframeWindow.document).trigger(b)}};Drupal.overlay.fragmentizeLink=function(c,f){var e=a.deparam.fragment(c.href);if(e.overlay){return c.href}var d=this.getPath(c,true);var b=d+c.search.replace(/&?render=overlay/,"").replace(/\?$/,"")+c.hash;return a.param.fragment(f||window.location.href,{overlay:b})};Drupal.overlay.refreshRegions=function(b){a.each(b,function(){var c=this;a.each(c,function(f){var e=c[f];var d="."+f;Drupal.detachBehaviors(a(d));a.get(Drupal.settings.basePath+Drupal.settings.overlay.ajaxCallback+"/"+e,function(g){a(d).replaceWith(a(g));Drupal.attachBehaviors(a(d),Drupal.settings)})})})};Drupal.overlay.resetActiveClass=function(b){var c=this;var d=window.location.protocol+window.location.hostname;a(".overlay-displace-top, .overlay-displace-bottom").find("a[href]").removeClass("active").each(function(){var f=this.protocol+this.hostname;var e=c.getPath(this);if(f==d&&(b+"/").indexOf(e+"/")===0&&(e!==""||b==="")){a(this).addClass("active")}})};Drupal.overlay.getPath=function(d,b){if(typeof d=="string"){d=a(d.link(d)).get(0)}var e=d.pathname;if(e.charAt(0)!="/"){e="/"+e}e=e.replace(new RegExp(Drupal.settings.basePath+"(?:index.php)?"),"");if(e==""&&!b){var c=new RegExp("([?&])q=(.+)([&#]|$)").exec(d.search);if(c&&c.length==4){e=c[2]}}return e};Drupal.overlay.getDisplacement=function(e){var c=0;var b=a(".overlay-displace-"+e+":last");if(b.length){c=b.offset().top+b.outerHeight();var f=b.css("box-shadow");var d=(typeof f!=="undefined"&&f!=="none");if(!d&&/DXImageTransform\.Microsoft\.Shadow/.test(b.css("filter"))){c-=b[0].filters.item("DXImageTransform.Microsoft.Shadow").strength;c=Math.max(0,c)}}return c};Drupal.overlay.makeDocumentUntabbable=function(c){if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8){a("#overlay-disable-message a",c).attr("tabindex",-1);return}c=c||document.body;var b,e,d;d=a("[tabindex] :not(.overlay-element)",c);d.each(Drupal.overlay._recordTabindex);Drupal.overlay._hasTabindex=d.add(Drupal.overlay._hasTabindex);e=a("a, area, button, input, object, select, textarea, iframe");e=e.add(d);b=a(".overlay-element, #overlay-container, .overlay-displace-top, .overlay-displace-bottom").find("*");e=e.not(b);e.attr("tabindex",-1)};Drupal.overlay.makeDocumentTabbable=function(d){if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8){return}var f;d=d||document.body;var b=a("[tabindex]",d);if(jQuery.browser.msie&&parseInt(jQuery.browser.version,10)<8){var c;var e=b.length;for(c=0;c<e;c++){b[c].removeAttribute("tabIndex")}}else{b.removeAttr("tabindex")}f=a(Drupal.overlay._hasTabindex,d);f.each(Drupal.overlay._restoreTabindex);Drupal.overlay._hasTabindex=Drupal.overlay._hasTabindex.not(f)};Drupal.overlay._recordTabindex=function(){var b=a(this);var c=a(this).attr("tabindex");b.data("drupalOverlayOriginalTabIndex",c)};Drupal.overlay._restoreTabindex=function(){var b=a(this);var c=b.data("drupalOverlayOriginalTabIndex");b.attr("tabindex",c)};Drupal.theme.prototype.overlayContainer=function(){return'<div id="overlay-container"><div class="overlay-modal-background"></div></div>'};Drupal.theme.prototype.overlayElement=function(b){return'<iframe class="overlay-element" frameborder="0" scrolling="auto" allowtransparency="true"></iframe>'}})(jQuery);