(function(a){Drupal.behaviors.tableDrag={attach:function(b,c){for(var d in c.tableDrag){a("#"+d,b).once("tabledrag",function(){Drupal.tableDrag[d]=new Drupal.tableDrag(this,c.tableDrag[d])})}}};Drupal.tableDrag=function(f,d){var c=this;this.table=f;this.tableSettings=d;this.dragObject=null;this.rowObject=null;this.oldRowElement=null;this.oldY=0;this.changed=false;this.maxDepth=0;this.rtl=a(this.table).css("direction")=="rtl"?-1:1;this.scrollSettings={amount:4,interval:50,trigger:70};this.scrollInterval=null;this.scrollY=0;this.windowHeight=0;this.indentEnabled=false;for(var h in d){for(var i in d[h]){if(d[h][i].relationship=="parent"){this.indentEnabled=true}if(d[h][i].limit>0){this.maxDepth=d[h][i].limit}}}if(this.indentEnabled){this.indentCount=1;var b=Drupal.theme("tableDragIndentation");var e=a("<tr/>").addClass("draggable").appendTo(f);var g=a("<td/>").appendTo(e).prepend(b).prepend(b);this.indentAmount=a(".indentation",g).get(1).offsetLeft-a(".indentation",g).get(0).offsetLeft;e.remove()}a("> tr.draggable, > tbody > tr.draggable",f).each(function(){c.makeDraggable(this)});a(f).before(a('<a href="#" class="tabledrag-toggle-weight"></a>').attr("title",Drupal.t("Re-order rows by numerical weight instead of dragging.")).click(function(){if(a.cookie("Drupal.tableDrag.showWeight")==1){c.hideColumns()}else{c.showColumns()}return false}).wrap('<div class="tabledrag-toggle-weight-wrapper"></div>').parent());c.initColumns();a(document).bind("mousemove",function(j){return c.dragRow(j,c)});a(document).bind("mouseup",function(j){return c.dropRow(j,c)})};Drupal.tableDrag.prototype.initColumns=function(){for(var g in this.tableSettings){for(var h in this.tableSettings[g]){var f=a("."+this.tableSettings[g][h].target+":first",this.table);if(f.length&&this.tableSettings[g][h].hidden){var e=this.tableSettings[g][h].hidden;var b=f.closest("td");break}}if(e&&b[0]){var c=a("> td",b.parent()).index(b.get(0))+1;a("> thead > tr, > tbody > tr, > tr",this.table).each(function(){var i=c;var d=a(this).children();d.each(function(j){if(j<i&&this.colSpan&&this.colSpan>1){i-=this.colSpan-1}});if(i>0){b=d.filter(":nth-child("+i+")");if(b[0].colSpan&&b[0].colSpan>1){b.addClass("tabledrag-has-colspan")}else{b.addClass("tabledrag-hide")}}})}}if(a.cookie("Drupal.tableDrag.showWeight")===null){a.cookie("Drupal.tableDrag.showWeight",0,{path:Drupal.settings.basePath,expires:365});this.hideColumns()}else{if(a.cookie("Drupal.tableDrag.showWeight")==1){this.showColumns()}else{this.hideColumns()}}};Drupal.tableDrag.prototype.hideColumns=function(){a(".tabledrag-hide","table.tabledrag-processed").css("display","none");a(".tabledrag-handle","table.tabledrag-processed").css("display","");a(".tabledrag-has-colspan","table.tabledrag-processed").each(function(){this.colSpan=this.colSpan-1});a(".tabledrag-toggle-weight").text(Drupal.t("Show row weights"));a.cookie("Drupal.tableDrag.showWeight",0,{path:Drupal.settings.basePath,expires:365});a("table.tabledrag-processed").trigger("columnschange","hide")};Drupal.tableDrag.prototype.showColumns=function(){a(".tabledrag-hide","table.tabledrag-processed").css("display","");a(".tabledrag-handle","table.tabledrag-processed").css("display","none");a(".tabledrag-has-colspan","table.tabledrag-processed").each(function(){this.colSpan=this.colSpan+1});a(".tabledrag-toggle-weight").text(Drupal.t("Hide row weights"));a.cookie("Drupal.tableDrag.showWeight",1,{path:Drupal.settings.basePath,expires:365});a("table.tabledrag-processed").trigger("columnschange","show")};Drupal.tableDrag.prototype.rowSettings=function(d,f){var c=a("."+d,f);for(var h in this.tableSettings[d]){var b=this.tableSettings[d][h].target;if(c.is("."+b)){var e={};for(var g in this.tableSettings[d][h]){e[g]=this.tableSettings[d][h][g]}return e}}};Drupal.tableDrag.prototype.makeDraggable=function(c){var b=this;var d=a('<a href="#" class="tabledrag-handle"><div class="handle">&nbsp;</div></a>').attr("title",Drupal.t("Drag to re-order"));if(a("td:first .indentation:last",c).length){a("td:first .indentation:last",c).after(d);b.indentCount=Math.max(a(".indentation",c).length,b.indentCount)}else{a("td:first",c).prepend(d)}d.hover(function(){b.dragObject==null?a(this).addClass("tabledrag-handle-hover"):null},function(){b.dragObject==null?a(this).removeClass("tabledrag-handle-hover"):null});d.mousedown(function(e){b.dragObject={};b.dragObject.initMouseOffset=b.getMouseOffset(c,e);b.dragObject.initMouseCoords=b.mouseCoords(e);if(b.indentEnabled){b.dragObject.indentMousePos=b.dragObject.initMouseCoords}if(b.rowObject){a("a.tabledrag-handle",b.rowObject.element).blur()}b.rowObject=new b.row(c,"mouse",b.indentEnabled,b.maxDepth,true);b.table.topY=a(b.table).offset().top;b.table.bottomY=b.table.topY+b.table.offsetHeight;a(this).addClass("tabledrag-handle-hover");a(c).addClass("drag");a("body").addClass("drag");if(b.oldRowElement){a(b.oldRowElement).removeClass("drag-previous")}if(navigator.userAgent.indexOf("MSIE 6.")!=-1){a("select",this.table).css("display","none")}b.safeBlur=false;b.onDrag();return false});d.click(function(){return false});d.focus(function(){a(this).addClass("tabledrag-handle-hover");b.safeBlur=true});d.blur(function(e){a(this).removeClass("tabledrag-handle-hover");if(b.rowObject&&b.safeBlur){b.dropRow(e,b)}});d.keydown(function(j){if(j.keyCode!=9&&!b.rowObject){b.rowObject=new b.row(c,"keyboard",b.indentEnabled,b.maxDepth,true)}var k=false;switch(j.keyCode){case 37:case 63234:k=true;b.rowObject.indent(-1*b.rtl);break;case 38:case 63232:var e=a(b.rowObject.element).prev("tr").get(0);while(e&&a(e).is(":hidden")){e=a(e).prev("tr").get(0)}if(e){b.safeBlur=false;b.rowObject.direction="up";k=true;if(a(c).is(".tabledrag-root")){var g=0;while(e&&a(".indentation",e).length){e=a(e).prev("tr").get(0);g+=a(e).is(":hidden")?0:e.offsetHeight}if(e){b.rowObject.swap("before",e);window.scrollBy(0,-g)}}else{if(b.table.tBodies[0].rows[0]!=e||a(e).is(".draggable")){b.rowObject.swap("before",e);b.rowObject.interval=null;b.rowObject.indent(0);window.scrollBy(0,-parseInt(c.offsetHeight,10))}}d.get(0).focus()}break;case 39:case 63235:k=true;b.rowObject.indent(1*b.rtl);break;case 40:case 63233:var i=a(b.rowObject.group).filter(":last").next("tr").get(0);while(i&&a(i).is(":hidden")){i=a(i).next("tr").get(0)}if(i){b.safeBlur=false;b.rowObject.direction="down";k=true;if(a(c).is(".tabledrag-root")){var g=0;var h=new b.row(i,"keyboard",b.indentEnabled,b.maxDepth,false);if(h){a(h.group).each(function(){g+=a(this).is(":hidden")?0:this.offsetHeight});var f=a(h.group).filter(":last").get(0);b.rowObject.swap("after",f);window.scrollBy(0,parseInt(g,10))}}else{b.rowObject.swap("after",i);b.rowObject.interval=null;b.rowObject.indent(0);window.scrollBy(0,parseInt(c.offsetHeight,10))}d.get(0).focus()}break}if(b.rowObject&&b.rowObject.changed==true){a(c).addClass("drag");if(b.oldRowElement){a(b.oldRowElement).removeClass("drag-previous")}b.oldRowElement=c;b.restripeTable();b.onDrag()}if(k){return false}});d.keypress(function(e){switch(e.keyCode){case 37:case 38:case 39:case 40:return false}})};Drupal.tableDrag.prototype.dragRow=function(c,j){if(j.dragObject){j.currentMouseCoords=j.mouseCoords(c);var f=j.currentMouseCoords.y-j.dragObject.initMouseOffset.y;var h=j.currentMouseCoords.x-j.dragObject.initMouseOffset.x;if(f!=j.oldY){j.rowObject.direction=f>j.oldY?"down":"up";j.oldY=f;var e=j.checkScroll(j.currentMouseCoords.y);clearInterval(j.scrollInterval);if(e>0&&j.rowObject.direction=="down"||e<0&&j.rowObject.direction=="up"){j.setScroll(e)}var i=j.findDropTargetRow(h,f);if(i){if(j.rowObject.direction=="down"){j.rowObject.swap("after",i,j)}else{j.rowObject.swap("before",i,j)}j.restripeTable()}}if(j.indentEnabled){var g=j.currentMouseCoords.x-j.dragObject.indentMousePos.x;var d=Math.round(g/j.indentAmount*j.rtl);var b=j.rowObject.indent(d);j.dragObject.indentMousePos.x+=j.indentAmount*b*j.rtl;j.indentCount=Math.max(j.indentCount,j.rowObject.indents)}return false}};Drupal.tableDrag.prototype.dropRow=function(d,b){if(b.rowObject!=null){var c=b.rowObject.element;if(b.rowObject.changed==true){b.updateFields(c);for(var e in b.tableSettings){var f=b.rowSettings(e,c);if(f.relationship=="group"){for(var g in b.rowObject.children){b.updateField(b.rowObject.children[g],e)}}}b.rowObject.markChanged();if(b.changed==false){a(Drupal.theme("tableDragChangedWarning")).insertBefore(b.table).hide().fadeIn("slow");b.changed=true}}if(b.indentEnabled){b.rowObject.removeIndentClasses()}if(b.oldRowElement){a(b.oldRowElement).removeClass("drag-previous")}a(c).removeClass("drag").addClass("drag-previous");b.oldRowElement=c;b.onDrop();b.rowObject=null}if(b.dragObject!=null){a(".tabledrag-handle",c).removeClass("tabledrag-handle-hover");b.dragObject=null;a("body").removeClass("drag");clearInterval(b.scrollInterval);if(navigator.userAgent.indexOf("MSIE 6.")!=-1){a("select",this.table).css("display","block")}}};Drupal.tableDrag.prototype.mouseCoords=function(b){if(b.pageX||b.pageY){return{x:b.pageX,y:b.pageY}}return{x:b.clientX+document.body.scrollLeft-document.body.clientLeft,y:b.clientY+document.body.scrollTop-document.body.clientTop}};Drupal.tableDrag.prototype.getMouseOffset=function(e,d){var c=a(e).offset();var b=this.mouseCoords(d);return{x:b.x-c.left,y:b.y-c.top}};Drupal.tableDrag.prototype.findDropTargetRow=function(c,i){var f=a(this.table.tBodies[0].rows).not(":hidden");for(var h=0;h<f.length;h++){var g=f[h];var d=0;var b=a(g).offset().top;if(g.offsetHeight==0){var e=parseInt(g.firstChild.offsetHeight,10)/2}else{var e=parseInt(g.offsetHeight,10)/2}if((i>(b-e))&&(i<(b+e))){if(this.indentEnabled){for(var h in this.rowObject.group){if(this.rowObject.group[h]==g){return null}}}else{if(g==this.rowObject.element){return null}}if(!this.rowObject.isValidSwap(g)){return null}while(a(g).is(":hidden")&&a(g).prev("tr").is(":hidden")){g=a(g).prev("tr").get(0)}return g}}return null};Drupal.tableDrag.prototype.updateFields=function(b){for(var c in this.tableSettings){this.updateField(b,c)}};Drupal.tableDrag.prototype.updateField=function(j,l){var c=this.rowSettings(l,j);if(c.relationship=="self"||c.relationship=="group"){var f=j}else{if(c.relationship=="sibling"){var o=a(j).prev("tr").get(0);var n=a(j).next("tr").get(0);var f=j;if(a(o).is(".draggable")&&a("."+l,o).length){if(this.indentEnabled){if(a(".indentations",o).length==a(".indentations",j)){f=o}}else{f=o}}else{if(a(n).is(".draggable")&&a("."+l,n).length){if(this.indentEnabled){if(a(".indentations",n).length==a(".indentations",j)){f=n}}else{f=n}}}}else{if(c.relationship=="parent"){var o=a(j).prev("tr");while(o.length&&a(".indentation",o).length>=this.rowObject.indents){o=o.prev("tr")}if(o.length){f=o[0]}else{f=a(this.table).find("tr.draggable:first").get(0);if(f==this.rowObject.element){f=a(this.rowObject.group[this.rowObject.group.length-1]).next("tr.draggable").get(0)}var e=true}}}}this.copyDragClasses(f,j,l);c=this.rowSettings(l,j);if(e){c.relationship="sibling";c.source=c.target}var m="."+c.target;var h=a(m,j).get(0);if(h){var d="."+c.source;var b=a(d,f).get(0);switch(c.action){case"depth":h.value=a(".indentation",a(b).closest("tr")).length;break;case"match":h.value=b.value;break;case"order":var i=this.rowObject.findSiblings(c);if(a(h).is("select")){var k=[];a("option",h).each(function(){k.push(this.value)});var p=k[k.length-1];a(m,i).each(function(){if(k.length>0){this.value=k.shift()}else{this.value=p}})}else{var g=parseInt(a(m,i[0]).val(),10)||0;a(m,i).each(function(){this.value=g;g++})}break}}};Drupal.tableDrag.prototype.copyDragClasses=function(f,d,e){var c=a("."+e,f);var b=a("."+e,d);if(c.length&&b.length){b[0].className=c[0].className}};Drupal.tableDrag.prototype.checkScroll=function(d){var i=document.documentElement;var c=document.body;var h=this.windowHeight=window.innerHeight||(i.clientHeight&&i.clientWidth!=0?i.clientHeight:c.offsetHeight);var f=this.scrollY=(document.all?(!i.scrollTop?c.scrollTop:i.scrollTop):(window.pageYOffset?window.pageYOffset:window.scrollY));var e=this.scrollSettings.trigger;var g=0;if(d-f>h-e){g=e/(h+f-d);g=(g>0&&g<e)?g:e;return g*this.scrollSettings.amount}else{if(d-f<e){g=e/(d-f);g=(g>0&&g<e)?g:e;return -g*this.scrollSettings.amount}}};Drupal.tableDrag.prototype.setScroll=function(c){var b=this;this.scrollInterval=setInterval(function(){b.checkScroll(b.currentMouseCoords.y);var e=b.scrollY>b.table.topY;var d=b.scrollY+b.windowHeight<b.table.bottomY;if(c>0&&d||c<0&&e){window.scrollBy(0,c)}},this.scrollSettings.interval)};Drupal.tableDrag.prototype.restripeTable=function(){a("> tbody > tr.draggable:visible, > tr.draggable:visible",this.table).removeClass("odd even").filter(":odd").addClass("even").end().filter(":even").addClass("odd")};Drupal.tableDrag.prototype.onDrag=function(){return null};Drupal.tableDrag.prototype.onDrop=function(){return null};Drupal.tableDrag.prototype.row=function(b,g,c,f,d){this.element=b;this.method=g;this.group=[b];this.groupDepth=a(".indentation",b).length;this.changed=false;this.table=a(b).closest("table").get(0);this.indentEnabled=c;this.maxDepth=f;this.direction="";if(this.indentEnabled){this.indents=a(".indentation",b).length;this.children=this.findChildren(d);this.group=a.merge(this.group,this.children);for(var e=0;e<this.group.length;e++){this.groupDepth=Math.max(a(".indentation",this.group[e]).length,this.groupDepth)}}};Drupal.tableDrag.prototype.row.prototype.findChildren=function(f){var b=this.indents;var d=a(this.element,this.table).next("tr.draggable");var e=[];var g=0;while(d.length){var c=a(".indentation",d).length;if(c>b){g++;e.push(d[0]);if(f){a(".indentation",d).each(function(h){if(g==1&&(h==b)){a(this).addClass("tree-child-first")}if(h==b){a(this).addClass("tree-child")}else{if(h>b){a(this).addClass("tree-child-horizontal")}}})}}else{break}d=d.next("tr.draggable")}if(f&&e.length){a(".indentation:nth-child("+(b+1)+")",e[e.length-1]).addClass("tree-child-last")}return e};Drupal.tableDrag.prototype.row.prototype.isValidSwap=function(c){if(this.indentEnabled){var d,b;if(this.direction=="down"){d=c;b=a(c).next("tr").get(0)}else{d=a(c).prev("tr").get(0);b=c}this.interval=this.validIndentInterval(d,b);if(this.interval.min>this.interval.max){return false}}if(this.table.tBodies[0].rows[0]==c&&a(c).is(":not(.draggable)")){return false}return true};Drupal.tableDrag.prototype.row.prototype.swap=function(b,c){Drupal.detachBehaviors(this.group,Drupal.settings,"move");a(c)[b](this.group);Drupal.attachBehaviors(this.group,Drupal.settings);this.changed=true;this.onSwap(c)};Drupal.tableDrag.prototype.row.prototype.validIndentInterval=function(e,b){var d,c;d=b?a(".indentation",b).length:0;if(!e||a(e).is(":not(.draggable)")||a(this.element).is(".tabledrag-root")){c=0}else{c=a(".indentation",e).length+(a(e).is(".tabledrag-leaf")?0:1);if(this.maxDepth){c=Math.min(c,this.maxDepth-(this.groupDepth-this.indents))}}return{min:d,max:c}};Drupal.tableDrag.prototype.row.prototype.indent=function(d){if(!this.interval){var f=a(this.element).prev("tr").get(0);var c=a(this.group).filter(":last").next("tr").get(0);this.interval=this.validIndentInterval(f,c)}var b=this.indents+d;b=Math.max(b,this.interval.min);b=Math.min(b,this.interval.max);d=b-this.indents;for(var e=1;e<=Math.abs(d);e++){if(d<0){a(".indentation:first",this.group).remove();this.indents--}else{a("td:first",this.group).prepend(Drupal.theme("tableDragIndentation"));this.indents++}}if(d){this.changed=true;this.groupDepth+=d;this.onIndent()}return d};Drupal.tableDrag.prototype.row.prototype.findSiblings=function(h){var g=[];var i=["prev","next"];var b=this.indents;for(var f=0;f<i.length;f++){var e=a(this.element)[i[f]]();while(e.length){if(a("."+h.target,e)){if(this.indentEnabled){var c=a(".indentation",e).length}if(!(this.indentEnabled)||(c==b)){g.push(e[0])}else{if(c<b){break}}}else{break}e=a(e)[i[f]]()}if(i[f]=="prev"){g.reverse();g.push(this.element)}}return g};Drupal.tableDrag.prototype.row.prototype.removeIndentClasses=function(){for(var b in this.children){a(".indentation",this.children[b]).removeClass("tree-child").removeClass("tree-child-first").removeClass("tree-child-last").removeClass("tree-child-horizontal")}};Drupal.tableDrag.prototype.row.prototype.markChanged=function(){var c=Drupal.theme("tableDragChangedMarker");var b=a("td:first",this.element);if(a("span.tabledrag-changed",b).length==0){b.append(c)}};Drupal.tableDrag.prototype.row.prototype.onIndent=function(){return null};Drupal.tableDrag.prototype.row.prototype.onSwap=function(b){return null};Drupal.theme.prototype.tableDragChangedMarker=function(){return'<span class="warning tabledrag-changed">*</span>'};Drupal.theme.prototype.tableDragIndentation=function(){return'<div class="indentation">&nbsp;</div>'};Drupal.theme.prototype.tableDragChangedWarning=function(){return'<div class="tabledrag-changed-warning messages warning">'+Drupal.theme("tableDragChangedMarker")+" "+Drupal.t("Changes made in this table will not be saved until the form is submitted.")+"</div>"}})(jQuery);